<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css" />
    
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>
    <script src="http://maps.google.com/maps/api/js?sensor=false&language=pl"></script>
    <script type="text/javascript" src="gmap3/gmap3.min.js"></script>
    <title>Listy jQuery</title>
    <style>
        #lista {
            padding:10px;
        }
        
        
        
    </style>
    <script>
        $(document).on("pageinit", "#secondPage", function (event) {
            
            var logo = document.getElementById("loadPage");
            logo.style.width = window.innerWidth + "px";
            logo.style.height = window.innerHeight  + "px";
            
            setTimeout(initMap, 1500);
           
            function initMap() {
                $("#secondPage").css("display", "block");
                    var crossImage = "/images/background.png";
                    var markers = [];
                    var colors = ["#ff3456", "#122334", "#443f6f", "#ff6333", "#4441f1", "#00ff11", "#65f321", "#9542ff", "#0000ff"];
                    var valuesMarkers = [];
                    var wholeTab = [];
                    var sendTab = [];
                    var markerNumber = 0;
                    var markerCounter = 0;
                    var tableWithAllTrips = [];
                    var tableWithAllColors = [];
                    var localTrip = [];
                    var drownPath = false;
                    var streetViewAble = false;
                    var streetViewPoint;
                    var pathColor = "#ffff00";
                    $("#mapDiv").width("100%");

                    $("#mapDiv").height(window.innerHeight - 84 + "px"); // max windows height minus header bar minus 30px padding
                    $("#mapDiv").gmap3({
                        map: {
                            events: {
                                click: function (map, event) {

                                    var latlng = new google.maps.LatLng(event.latLng.lat(), event.latLng.lng());

                                    var newMarker = new google.maps.Marker({
                                        tag: markerNumber,
                                        name: 'Marker',
                                        position: latlng,
                                        animation: google.maps.Animation.DROP,
                                        title: 'marker',
                                        draggable: false,
                                        map: map
                                    });

                                    // tab.push({ lat: event.latLng.lat(), lng: event.latLng.lng() });
                                    if (streetViewAble) {
                                        streetViewPoint = new google.maps.LatLng(event.latLng.lat(), event.latLng.lng());
                                        GoToStreetView();
                                        
                                    }
                                    
                                        markers.push(newMarker);
                                        valuesMarkers[markerNumber] = [];
                                        valuesMarkers[markerNumber][0] = event.latLng.lat();
                                        valuesMarkers[markerNumber][1] = event.latLng.lng();
                                    
                                    
                                    

                                    $("#lista").append("<li id=" + markerNumber + " value=" + markerNumber + "><a  id=li" + markerNumber + ">miejsce " + (markerCounter + 1) + "</a><a id=" + markerNumber + " data-icon='delete'></li>");
                                    $("#lista").listview("refresh");
                                    markerNumber++;
                                    markerCounter++;

                                    CreateWholeTab(); 
                                }

                            }
                        }
                    })

                    //remove whole trip
                    $("#removeAll").click(function () {
                        ClearMap();

                    })
                    function ClearMap() {
                        $("#mapDiv").gmap3({
                            clear: {
                                polyline: []             /// clear poly line
                            }

                        })

                        for (var doUsuwania = 0; doUsuwania < markerNumber; doUsuwania++) {
                            $("#li" + doUsuwania).parent().parent().parent().remove();    // clear li html elements

                        }

                        for (var i = 0; i > -markers.length; i--) {
                            if (markers[-i] != null)
                                markers[-i].setMap(null);

                        }
                        //clear table with markers: for, markersNumber, markers,valueMarkers
                        markerNumber = 0;
                        markers = [];
                        valuesMarkers = [];

                        $("#lista").listview("refresh");
                    }
                    //END remove whole trip

                    //remove one marker
                    $("#lista").on("click", "a", function () {

                        var index = $(this).parent().parent().parent().parent().index();
                        if (this.id >= 0 && valuesMarkers[index] != undefined) {
                            var indexInTab = this.id;


                            var item = $(this).parent();

                            markers[indexInTab].setMap(null);
                            markers[indexInTab] = null;
                            valuesMarkers[indexInTab][0] = null;
                            valuesMarkers[indexInTab][1] = null;
                            item.remove();
                            if (drownPath) {
                                MakePath();
                            }
                        }


                    })
                    //END remove one marker

                    //tap map
                    $("#lista").on("click", "li", function () {

                        //var index = $(this).index();
                        var index = this.id;
                        if (valuesMarkers[index] != undefined) {
                            $("#mapDiv").gmap3({
                                map: {
                                    options: {
                                        center: [valuesMarkers[index][0], valuesMarkers[index][1]],
                                        latLng: [valuesMarkers[index][0], valuesMarkers[index][1]],
                                        disableDefaultUI: true

                                    },
                                }
                            })
                        }

                    })
                    //END tap map

                    //suwaki
                    function zmiana() {
                        $("#mapDiv").gmap3({
                            map: {
                                options: {
                                    center: [$("#r1").val(), $("#r2").val()],
                                    latLng: [$("#r1").val(), $("#r2").val()],
                                    zoom: parseInt($("#r3").val()),
                                    disableDefaultUI: true

                                },
                            }
                        })
                    }

                    $("#r1").change(function () {
                        zmiana();
                    })
                    $("#r2").change(function () {
                        zmiana();
                    })
                    $("#r3").change(function () {
                        zmiana();
                    })
                    // koniec suwaków

                    $("#streetView").click(function () {
                        //$("#panel").panel("open");             

                        if (streetViewAble)              /// when is open
                        {
                            alert("Koniec StreetView!")
                            $("#mapDiv").width("100%");
                            $("#mapDiv").height(window.innerHeight - 84 + "px");
                            $(".googlemap").remove();

                        }
                       else                     // when is close
                        {
                            alert("Kliknij w mapę aby przeniść się do SteetView. W przypadku braku widoku rzeczywistego dolna część ekrazu pozostanie biała!")                                               
                        }
                        $("#panel").panel("close");
                        streetViewAble = !streetViewAble;
                    })

                    function GoToStreetView()
                    {
                        
                        $("#mapDiv").gmap3({
                            map: {
                                options: {
                                    zoom: 14,
                                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                                    streetViewControl: false,
                                    center: streetViewPoint
                                }
                            },
                            streetviewpanorama: {
                                options: {
                                    container: $(document.createElement("div")).addClass("googlemap").insertAfter($("#mapDiv")),
                                    opts: {
                                        position: streetViewPoint,
                                        pov: {
                                            heading: 340,
                                            pitch: 10,
                                            zoom: 1
                                        }
                                    }
                                }
                            }


                        });

                        $("#mapDiv").height(((window.innerHeight - 84) / 2) + "px");
                        $(".googlemap").width("100%");
                        $(".googlemap").height(((window.innerHeight - 84) / 2) + "px");
                    }
                    $("#openPanel").click(function () {
                        $("#panel").panel("open");
                    })

                    $("#makePath").click(function () {
                        MakePath();
                        drownPath = true;

                    })

                    //Function drawing path
                    function MakePath() {


                        CreateWholeTab();

                        $("#mapDiv").gmap3({
                            clear: {
                                polyline: []             /// clear poly line
                            }

                        })
                        if (wholeTab.length > 0) {
                            $("#mapDiv").gmap3({
                                polyline: {
                                    options: {
                                        strokeColor: pathColor,
                                        strokeOpacity: 0.8,
                                        strokeWeight: 2,
                                        path: wholeTab
                                    }
                                }
                            })
                        }
                    }

                    function CreateWholeTab() {
                        wholeTab = [];
                        var drawPosition = 0;
                        if (valuesMarkers.length > 0)          // check if exit any marker
                        {
                            for (var i = 0; i < valuesMarkers.length ; i++) {
                                if (valuesMarkers[i][0] != null && valuesMarkers[i][1] != null) {
                                    wholeTab[drawPosition] = [];
                                    wholeTab[drawPosition][0] = valuesMarkers[i][0];
                                    wholeTab[drawPosition][1] = valuesMarkers[i][1];
                                    drawPosition++;;
                                }

                            }
                        }


                    }
                    $("#changeColor").click(function () { // cala funkcja wyswietla kolory, po kliknieciu zamyka
                        $("#popup").empty();
                        var foo = 0;            // "wskaznik" na kolory

                        $("#popup").width("200px");
                        $("#popup").height("300px");
                        var tekst = document.createElement("p");
                        tekst.innerHTML = "Wybierz kolor trasy";
                        tekst.style.width = 100 + "%";
                        tekst.style.paddingTop = 10 + "px";
                        tekst.style.paddingBottom = 10 + "px";
                        tekst.style.textAlign = "center";
                        tekst.style.color = "#ffffff";
                        tekst.style.background = "#0000ff";

                        $("#popup").append(tekst);

                        for (var column = 0; column < 3; column++) {

                            for (var row = 0; row < 3; row++) {

                                var colorArea = document.createElement("div");
                                colorArea.setAttribute("id", colors[foo]);
                                colorArea.addEventListener("click", selectColor, true);
                                colorArea.style.position = "absolute";
                                colorArea.style.width = 50 + "px";
                                colorArea.style.height = 50 + "px";
                                colorArea.style.marginLeft = ((row * 50) + (20 * row)) + "px";
                                colorArea.style.marginTop = ((column * 50) + (20 * column)) + "px";
                                colorArea.style.borderRadius = 100 + "px";
                                colorArea.style.padding = 5 + "px";
                                colorArea.style.background = colors[foo];
                                $("#popup").append(colorArea);

                                foo++;
                            }
                            $("#popup").append("<br/>");
                        }
                        $("#popup").append();
                        $("#popup").popup("open");
                    })

                    function selectColor(e) {
                        pathColor = e.target.id;  // change path color
                        $("#popup").popup("close");

                    }

                    $("#mapDiv").taphold(function () {    // change background type
                        $("#popupBackground").empty();

                        $("#popupBackground").width("239px");
                        $("#popupBackground").height("295px");


                        var image = ["/images/round.png", "/images/hybrid.png", "/images/satellite.png", "/images/terrain.png"];
                        for (var i = 0; i < 4; i++) {
                            var appendImage = document.createElement("img");
                            appendImage.src = image[i];

                            $("#popupBackground").append(appendImage);
                            if (i == 1) {
                                appendImage.addEventListener("click", setBackgroundHybrid, false);
                                $("#popupBackground").append("<br/>")
                            }
                            else if (i == 0) {
                                appendImage.addEventListener("click", setBackgroundRound, false);
                            }
                            else if (i == 2) {
                                appendImage.addEventListener("click", setBackgroundSatellite, false);
                            }
                            else if (i == 3) {
                                appendImage.addEventListener("click", setBackgroundTerrain, false);
                            }

                        }

                        $("#popupBackground").popup("open");


                        function setBackgroundHybrid() {
                            var map = $("#mapDiv").gmap3("get");
                            map.setMapTypeId(google.maps.MapTypeId.HYBRID);
                            $("#popupBackground").popup("close");
                        }
                        function setBackgroundRound() {
                            var map = $("#mapDiv").gmap3("get");
                            map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
                            $("#popupBackground").popup("close");
                        }
                        function setBackgroundSatellite() {
                            var map = $("#mapDiv").gmap3("get");
                            map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
                            $("#popupBackground").popup("close");
                        }
                        function setBackgroundTerrain() {
                            var map = $("#mapDiv").gmap3("get");
                            map.setMapTypeId(google.maps.MapTypeId.TERRAIN);
                            $("#popupBackground").popup("close");
                        }


                    })


                    //local save
                    $("#localSave").click(function () {
                        $.mobile.showPageLoadingMsg();

                        for (var i = 0; i < wholeTab.length; i++) {
                            sendTab.push([parseInt(wholeTab[i][0]), parseInt(wholeTab[i][1])]);
                        }

                        var sendObj = {
                            wycieczka: JSON.stringify(sendTab)
                        }

                        $.ajax({
                            type: "POST",
                            url: "http://localhost:52112/SaveFile.aspx",
                            data: sendObj,
                            dataType: "text",
                            success: function (response) {
                                $.mobile.hidePageLoadingMsg();
                                alert(response);
                            },
                            error: function (xhr) {
                                alert(xhr.responseText)
                            }
                        })
                    })

                    //end local save

                    //local get from server
                    $("#getFromLocalServer").click(function () {
                        $.ajax({
                            type: "POST",
                            url: "http://localhost:52112/ReadLocalTrip.aspx",
                            dataType: "text",
                            success: onSuccess,
                            error: onError

                        })
                        function onSuccess(response) {
                            localTrip = [];
                            var allTripsOnServer = JSON.parse(response);                            
                            var amountTrips = allTripsOnServer.length;
                            var longLastTrip = allTripsOnServer[amountTrips - 1].length;                         
                            
                            for(var i = 0;i<longLastTrip;i++)
                            {
                                localTrip.push(allTripsOnServer[amountTrips - 1][i]);
                            }
                            console.log(localTrip);

                            ClearMap();

                            $("#mapDiv").gmap3({
                                clear: {
                                    polyline: []             /// clear poly line
                                }
                            })

                            $("#mapDiv").gmap3({
                                marker: {
                                    values: localTrip
                                },
                                polyline: {
                                    options: {
                                        strokeColor: pathColor,
                                        strokeOpacity: 0.5,
                                        strokeWeight: 4,
                                        path: localTrip
                                    }
                                },
                                autofit: {} // focus na wycieczkę - przybliżenie

                            })


                            //alert(allTripsOnServer);*/


                        }
                        function onError(xhr) {
                            alert(xhr.responseText);
                        }

                    })
                    //END local get from server
                    //server save
                    $("#sendOnSever").click(function () {
                        if (wholeTab.length > 0) {
                            sendTab = [];
                            var name = prompt("Podaj imię");

                            var color = pathColor;
                            var date = new Date();
                            var wholeDate = (date.getDay() + 1) + "-" + (date.getMonth() + 1) + "-" + date.getFullYear() + " " + date.toLocaleTimeString();

                            $.mobile.showPageLoadingMsg();

                            sendTab.push(name, color, wholeDate);
                            for (var i = 0; i < wholeTab.length; i++) {
                                //sendTab.push([parseFloat(wholeTab[i][0]).toFixed(2), parseFloat(wholeTab[i][1]).toFixed(2)]);
                                sendTab.push([parseInt(wholeTab[i][0]), parseInt(wholeTab[i][1])]);
                            }
                            console.log()
                            var sendObj = {
                                wycieczka: JSON.stringify(sendTab)
                            }

                            $.ajax({
                                type: "POST",
                                url: "http://3ib1.spec.pl.hostingasp.pl/Miszczak_Kornel/TRIPS_PROJECT/SendTrips.aspx",
                                data: sendObj,
                                dataType: "text",
                                success: function (response) {
                                    $.mobile.hidePageLoadingMsg();
                                    alert(response);
                                },
                                error: function (xhr) {
                                    alert(xhr.responseText)
                                }
                            })
                        }
                        else {
                            alert("Nie ma wycieczki");
                        }
                    })
                    //END serve save            
                    //get from server
                    $("#getFromServer").click(function () {
                        $.ajax({
                            type: "POST",
                            url: "http://3ib1.spec.pl.hostingasp.pl/Miszczak_Kornel/TRIPS_PROJECT/ReadTrips.aspx",
                            dataType: "text",
                            success: onSuccess,
                            error: onError

                        })
                        function onSuccess(response) {
                            $("#listaZwycieczkami").empty();
                            var allTripsOnServer = JSON.parse(response);
                            var amountTrips = allTripsOnServer.length;
                            for (var i = 0; i < amountTrips; i++) {
                                var name = allTripsOnServer[i][0];
                                if (name.length == 0)
                                    name = "Brak Nazwy";
                                var color = allTripsOnServer[i][1];            // set name, date and color 
                                var date = allTripsOnServer[i][2];
                                var amountMarkers = allTripsOnServer[i].length;
                                var tabWithMarkers = [];
                                for (var j = 0; j < amountMarkers - 3; j++) {

                                    tabWithMarkers.push(allTripsOnServer[i][j + 3]);
                                }
                                tableWithAllColors.push(color);
                                tableWithAllTrips.push(tabWithMarkers);            // add one trip to array with all trips
                                $("#listaZwycieczkami").append("<li style='margin:3px;' id=" + i + "><a>" + name + " - " + date + "</a></li>");
                                $("#listaZwycieczkami").listview("refresh");

                            }


                            //alert(allTripsOnServer);


                        }
                        function onError(xhr) {
                            alert(xhr.responseText);
                        }


                    })
                    //END get from server


                    //drawing selected path
                    $("#listaZwycieczkami").on("click", "li", function () {

                        var index = $(this).index();
                        var trip = tableWithAllTrips[index];  // table with all places and atributes
                        var color = tableWithAllColors[index]; // table with all colors

                        ClearMap();

                        $("#mapDiv").gmap3({
                            clear: {
                                polyline: []             /// clear poly line
                            }
                        })

                        $("#mapDiv").gmap3({
                            marker: {
                                values: trip
                            },
                            polyline: {
                                options: {
                                    strokeColor: color,
                                    strokeOpacity: 0.5,
                                    strokeWeight: 4,
                                    path: trip
                                }
                            },
                            autofit: {} // focus na wycieczkę - przybliżenie

                        })


                    })
                    //END drawing selected path

                    //second panle
                    $("#openPanelZwycieczkami").click(function () {
                        $("#panelZwycieczkami").panel("open");
                    })
                    //end secondpanel


                    //<ul data-role="listview" id="lista"></ul>


                    $("#closeApplication").click(function () {
                        navigator.app.exitApp();
                    })

                    //GOELOKALIZACJA
                    $("#currentLocalization").click(function () {
                        $.mobile.showPageLoadingMsg();
                        navigator.geolocation.getCurrentPosition(
                            function (position) {
                                $.mobile.hidePageLoadingMsg();
                                $("#mapDiv").gmap3({
                                    map: {
                                        options: {
                                            center: [position.coords.latitude, position.coords.longitude],
                                            latLng: [position.coords.latitude, position.coords.longitude],
                                            zoom: 15
                                        },
                                    },
                                    marker: {
                                        options: {
                                            draggable: false,                                            
                                        },
                                        latLng: [position.coords.latitude, position.coords.longitude]                                        
                                    }
                                });
                            },
                            function (error) {
                                $.mobile.hidePageLoadingMsg();
                                alert("Error");
                            },
                            {
                                maximumAge: 10000,
                                timeout: 10000,
                                enableHighAccuracy: true
                            }
                        );
                    });
                     
            }



            


            })
            ////////////////////////////koniec konieckonieckonieckonieckonieckoniec vv koniec
            /// ************************koniec
        //////////////////////////////////koniec
        //<img id="loadPage"  src="round.png" alt="">
       // })
    </script>
</head>
<body style="margin:0" >
    <div id="firstPage" style="padding:0px;margin:0px"><img id="loadPage" style="padding:0px;margin:0px;position:fixed; left:0;top:0" src="./images/logo.png" alt=""></div>
    <div id="secondPage" style="display:none" >
        <div data-role="page" data-theme="b">
            <div id="panel" data-theme="a" data-display="overlay" data-role="panel">
                <ul id="lista" data-role="listview"></ul>     
                                    
                <input id="streetView" type="button" value="Street View" data-corners="false" data-icon="star" />
                <input id="getFromLocalServer" type="button" value="Narysuj wycieczkę" data-corners="false" data-icon="edit" />
                <input id="localSave" type="button" value="Zapisz wycieczkę" data-corners="false" data-icon="navigation" />
                <input id="removeAll" type="button" value="Usuń wycieczkę" data-corners="false" data-icon="delete"/>
                <input id="sendOnSever" type="button" value="Wyślij na server" data-corners="false" data-icon="check" />

            </div>
            <div id="panelZwycieczkami" data-theme="a" data-display="overlay" data-role="panel">
                <ul id="getFromServer" data-role="listview" style="margin:10px; margin-bottom:30px" data-icon="refresh"><li><a>Odśwież wycieczki</a></li></ul>
                <ul id="listaZwycieczkami" data-role="listview"></ul>
            </div>           
            <div data-role="header">
                
                    <img src="images/mainMenu.png" id="openPanel" alt="Menu">
                    <img src="images/tripsList.png" id="openPanelZwycieczkami" alt="Lista wycieczek" />
                    <img src="images/currentPosition.png" id="currentLocalization" alt="Lokalizacja" />
                    <img src="images/makePath.png" id="makePath" alt="Rysuj" style="width:48px;" />
                    <img src="images/colorsChange.png" id="changeColor" alt="Zmień kolor" style="width:48px;" />
                    <img src="images/exit.png" id="closeApplication" alt="Wyjście" />
                
                <!--<input id="openPanel" type="button" value="panel" />
                <input id="openPanelZwycieczkami" type="button" value="panelZwyczieczkami" />                
                <input id="changeColor" type="button" value="change color" />
                <input id="makePath" type="button" value="make path" />
                <input id="closeApplication" type="button" value="Zamknij " />
                <input id="currentLocalization" type="button" value="Lokalizacja" />
                    -->
            </div>

            <div data-role="content">
                <div id="mapDiv"></div>
                <!--
                <div id="realStreetView"></div>
                <input type="range" id="r1" min="-90" max="90" value="0" />
                <input type="range" id="r2" min="-180" max="180" value="0" />
                <input type="range" id="r3" min="1" max="20" value="2" />
                <input id="saveThisPlace" type="button" value="zapisz to miejsce" />
                    -->


                <div data-role="popup" id="popup" class="ui-content"></div>
                <div data-role="popup" style="padding:0px" id="popupBackground" class="ui-content"></div>
            </div>


        </div>
    </div>
    <!--<script type="text/javascript" src="cordova.js"></script>-->


</body>
</html>
